{% extends 'base.html' %}

{% block title %}{{ company.name if company and company.name else 'Company' }} Dashboard - ChurnPredict Pro{% endblock %}

{% block content %}
<div class="min-vh-100 d-flex align-items-center justify-content-center bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Welcome Card -->
                <div class="card shadow-lg mb-4">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-chart-line fa-4x text-primary mb-4"></i>
                        <h1 class="display-4 mb-3">
                            Welcome to {{ company.name if company and hasattr(company, 'name') and company.name else 'Your Company' }} CRM
                        </h1>
                        <p class="lead text-muted mb-4">
                            {% if current_user.is_authenticated %}
                                Hello, {{ current_user.full_name if current_user.full_name else current_user.username if current_user.username else 'User' }}!
                            {% endif %}
                        </p>
                        <p class="text-muted">
                            Your intelligent customer churn prediction platform
                        </p>
                    </div>
                </div>

                <!-- Error Handling Alert -->
                {% if not stats %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Dashboard Loading:</strong> Some statistics may be temporarily unavailable.
                </div>
                {% endif %}

                <!-- Quick Stats with Safe Access -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card border-left-primary">
                            <div class="card-body">
                                <h6 class="text-primary text-uppercase mb-1">Customers</h6>
                                <h3 class="mb-0">
                                    {% if stats and hasattr(stats, 'total_customers') %}
                                        {{ stats.total_customers|number if stats.total_customers is not none else 0 }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h3>
                                <small class="text-muted">Total customers</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-left-info">
                            <div class="card-body">
                                <h6 class="text-info text-uppercase mb-1">Tickets</h6>
                                <h3 class="mb-0">
                                    {% if stats and hasattr(stats, 'total_tickets') %}
                                        {{ stats.total_tickets|number if stats.total_tickets is not none else 0 }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h3>
                                <small class="text-muted">Support tickets</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-left-success">
                            <div class="card-body">
                                <h6 class="text-success text-uppercase mb-1">Payments</h6>
                                <h3 class="mb-0">
                                    {% if stats and hasattr(stats, 'total_payments') %}
                                        {{ stats.total_payments|number if stats.total_payments is not none else 0 }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h3>
                                <small class="text-muted">Transactions</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card border-left-danger">
                            <div class="card-body">
                                <h6 class="text-danger text-uppercase mb-1">High Risk</h6>
                                <h3 class="mb-0">
                                    {% if stats and hasattr(stats, 'high_risk_customers') %}
                                        {{ stats.high_risk_customers|number if stats.high_risk_customers is not none else 0 }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </h3>
                                <small class="text-muted">At-risk customers</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Status Alerts -->
                {% set total_customers = stats.total_customers if stats and hasattr(stats, 'total_customers') and stats.total_customers else 0 %}
                
                {% if total_customers == 0 %}
                <div class="alert alert-warning" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>No customer data found!</strong> 
                    Start by configuring your CRM connection in Company Settings, then sync your data.
                </div>
                {% endif %}

                <!-- Configuration Status -->
                {% if connection_info and connection_info.preferred_method == 'none' %}
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Setup Required:</strong> Configure PostgreSQL or API connection in Company Settings for data synchronization.
                </div>
                {% endif %}

                <!-- Quick Actions -->
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-building fa-3x text-primary mb-3"></i>
                                <h5>Company Settings</h5>
                                <p class="text-muted small">Manage company information and CRM integration</p>
                                <a href="{{ url_for('company.settings') }}" class="btn btn-primary btn-sm">
                                    Manage Settings <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-sync-alt fa-3x text-info mb-3"></i>
                                <h5>CRM Sync</h5>
                                <p class="text-muted small">Synchronize customer data from your CRM system</p>
                                {% if connection_info and connection_info.preferred_method != 'none' %}
                                    <button onclick="startSync()" class="btn btn-info btn-sm" id="syncBtn">
                                        <span id="syncBtnText">Start Sync</span> <i class="fas fa-sync ms-1" id="syncIcon"></i>
                                    </button>
                                {% else %}
                                    <a href="{{ url_for('company.settings') }}" class="btn btn-outline-info btn-sm">
                                        Configure CRM <i class="fas fa-cog ms-1"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-bar fa-3x text-success mb-3"></i>
                                <h5>Analytics</h5>
                                <p class="text-muted small">View detailed analytics and churn predictions</p>
                                {% if total_customers > 0 %}
                                    <button onclick="window.location.href='/analytics'" class="btn btn-success btn-sm">
                                        View Analytics <i class="fas fa-chart-line ms-1"></i>
                                    </button>
                                {% else %}
                                    <button class="btn btn-outline-success btn-sm" disabled>
                                        Analytics <i class="fas fa-chart-line ms-1"></i>
                                    </button>
                                    <small class="text-muted d-block mt-1">Sync data first</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- System Status -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    System Status
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <!-- Data Status -->
                                        <h6 class="text-muted mb-2">Data Overview</h6>
                                        {% if total_customers > 0 %}
                                            <p class="mb-1">
                                                <i class="fas fa-check-circle text-success me-2"></i>
                                                Managing {{ total_customers }} customers
                                            </p>
                                            {% set high_risk = stats.high_risk_customers if stats and hasattr(stats, 'high_risk_customers') and stats.high_risk_customers else 0 %}
                                            {% if high_risk > 0 %}
                                            <p class="mb-1">
                                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                                {{ high_risk }} customers at high churn risk
                                            </p>
                                            {% endif %}
                                        {% else %}
                                            <p class="mb-1">
                                                <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                No customer data available
                                            </p>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <!-- Connection Status -->
                                        <h6 class="text-muted mb-2">Connection Status</h6>
                                        {% if connection_info %}
                                            {% if connection_info.preferred_method == 'postgresql' %}
                                                <p class="mb-1">
                                                    <i class="fas fa-database text-success me-2"></i>
                                                    PostgreSQL configured (High Performance)
                                                </p>
                                            {% elif connection_info.preferred_method == 'api' %}
                                                <p class="mb-1">
                                                    <i class="fas fa-cloud text-info me-2"></i>
                                                    API configured (Standard Performance)
                                                </p>
                                            {% else %}
                                                <p class="mb-1">
                                                    <i class="fas fa-times-circle text-danger me-2"></i>
                                                    No connection configured
                                                </p>
                                            {% endif %}
                                        {% else %}
                                            <p class="mb-1">
                                                <i class="fas fa-question-circle text-muted me-2"></i>
                                                Connection status unknown
                                            </p>
                                        {% endif %}
                                        
                                        <!-- Last Sync -->
                                        {% if stats and hasattr(stats, 'last_sync') and stats.last_sync %}
                                            <p class="mb-1">
                                                <i class="fas fa-clock text-info me-2"></i>
                                                Last sync: {{ stats.last_sync.strftime('%Y-%m-%d %H:%M') if stats.last_sync.strftime else stats.last_sync }}
                                            </p>
                                        {% else %}
                                            <p class="mb-1">
                                                <i class="fas fa-clock text-muted me-2"></i>
                                                No recent sync
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="syncToast" class="toast" role="alert">
        <div class="toast-header">
            <strong class="me-auto">CRM Sync</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="syncToastBody">
            <!-- Toast message will be inserted here -->
        </div>
    </div>
</div>

<script>
// Auto-refresh stats periodically (if API is available)
let statsRefreshInterval;

function refreshStats() {
    fetch('{{ url_for("company.api_stats") }}')
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                // Update stats on page (optional - uncomment if you want live updates)
                // updateStatsDisplay(data);
                console.log('Stats refreshed successfully');
            }
        })
        .catch(error => {
            console.log('Stats refresh error (this is normal):', error);
        });
}

// Start auto-refresh if we have working stats API
try {
    refreshStats();
    statsRefreshInterval = setInterval(refreshStats, 60000); // Every minute
} catch (e) {
    console.log('Auto-refresh not available');
}

// Sync functionality
function startSync() {
    const syncBtn = document.getElementById('syncBtn');
    const syncBtnText = document.getElementById('syncBtnText');
    const syncIcon = document.getElementById('syncIcon');
    
    if (syncBtn) {
        syncBtn.disabled = true;
        syncBtnText.textContent = 'Syncing...';
        syncIcon.classList.add('fa-spin');
        
        // Show toast
        showToast('Starting CRM synchronization...', 'info');
        
        // Simulate sync (replace with actual fetch to sync endpoint)
        setTimeout(() => {
            syncBtn.disabled = false;
            syncBtnText.textContent = 'Start Sync';
            syncIcon.classList.remove('fa-spin');
            showToast('Sync completed! Refresh page to see updated data.', 'success');
        }, 3000);
    }
}

function showToast(message, type = 'info') {
    const toastElement = document.getElementById('syncToast');
    const toastBody = document.getElementById('syncToastBody');
    
    if (toastElement && toastBody) {
        toastBody.textContent = message;
        
        // Add color class based on type
        toastElement.className = 'toast';
        if (type === 'success') {
            toastElement.classList.add('bg-success', 'text-white');
        } else if (type === 'error') {
            toastElement.classList.add('bg-danger', 'text-white');
        } else {
            toastElement.classList.add('bg-info', 'text-white');
        }
        
        // Show toast (Bootstrap 5)
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    }
}

// Cleanup interval on page unload
window.addEventListener('beforeunload', function() {
    if (statsRefreshInterval) {
        clearInterval(statsRefreshInterval);
    }
});
</script>

<!-- Custom CSS for border styling -->
<style>
.border-left-primary {
    border-left: 4px solid #4e73df !important;
}
.border-left-info {
    border-left: 4px solid #36b9cc !important;
}
.border-left-success {
    border-left: 4px solid #1cc88a !important;
}
.border-left-danger {
    border-left: 4px solid #e74a3b !important;
}
</style>
{% endblock %}