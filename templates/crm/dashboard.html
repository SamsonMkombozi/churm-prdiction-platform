{% extends 'base.html' %}

{% block title %}Enhanced CRM Dashboard with Predictions - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-brain me-2"></i>Enhanced CRM Dashboard with Payment-Based Predictions
            {% if connection_info.prediction_enabled %}
            <span class="badge bg-success ms-2">Predictions Active</span>
            {% endif %}
            {% if connection_info.postgresql_configured %}
            <span class="badge bg-primary ms-2">PostgreSQL</span>
            {% elif connection_info.api_configured %}
            <span class="badge bg-warning ms-2">API Fallback</span>
            {% else %}
            <span class="badge bg-danger ms-2">Not Configured</span>
            {% endif %}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            {% if current_user.is_manager() %}
            <!-- âœ… ENHANCED: PostgreSQL + Predictions aware sync button -->
            <button type="button" class="btn btn-primary me-2" id="syncButton" 
                    data-bs-toggle="modal" data-bs-target="#syncModal">
                <i class="fas fa-sync-alt me-2"></i>
                {% if connection_info.postgresql_configured %}
                    Fast Sync + Predictions
                {% else %}
                    Sync CRM Data
                {% endif %}
            </button>
            
            <!-- âœ… NEW: Prediction-specific actions -->
            <button type="button" class="btn btn-success me-2" onclick="viewPredictionSummary()">
                <i class="fas fa-chart-line me-2"></i>Prediction Analytics
            </button>
            
            {% if stats.customers_with_predictions > 0 %}
            <button type="button" class="btn btn-warning me-2" onclick="regeneratePredictions()">
                <i class="fas fa-redo me-2"></i>Update Predictions
            </button>
            {% endif %}
            
            {% if connection_info.postgresql_configured %}
            <button type="button" class="btn btn-info me-2" onclick="showConnectionInfo()">
                <i class="fas fa-database me-2"></i>Performance Info
            </button>
            {% endif %}
            {% endif %}
            
            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- âœ… NEW: Payment-Based Prediction Alert -->
    {% if connection_info.prediction_enabled and connection_info.postgresql_configured %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-brain fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">ðŸ§  Payment-Based Churn Prediction Active!</h5>
                <p class="mb-0">Your system now uses <strong>payment behavior analysis</strong> from the n.py logic for accurate churn prediction. Real-time risk assessment with multi-table mapping!</p>
                <small class="text-success">
                    <strong>Features:</strong> 90-day payment rules â€¢ Real-time risk scoring â€¢ Multi-table analysis (customers, payments, tickets, usage)
                </small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}

    <!-- âœ… ENHANCED: Statistics Cards with Prediction Analytics -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Customers
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(stats.customers if stats.customers else 0) }}
                            </div>
                            {% if stats.customers_with_predictions > 0 %}
                            <small class="text-success">
                                {{ "{:,}".format(stats.customers_with_predictions) }} with predictions
                            </small>
                            {% endif %}
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- âœ… NEW: High Risk Customers Card -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-danger shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                High Risk
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(stats.high_risk_customers if stats.high_risk_customers else 0) }}
                            </div>
                            <small class="text-danger">90+ days no payment</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- âœ… NEW: Medium Risk Customers Card -->
        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Medium Risk
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(stats.medium_risk_customers if stats.medium_risk_customers else 0) }}
                            </div>
                            <small class="text-warning">60+ days no payment</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Active Customers
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(stats.active_customers if stats.active_customers else 0) }}
                            </div>
                            <small class="text-success">{{ "{:,}".format(stats.low_risk_customers) }} low risk</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                Support Tickets
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ "{:,}".format(stats.tickets if stats.tickets else 0) }}
                            </div>
                            <small class="text-muted">{{ "{:,}".format(stats.open_tickets if stats.open_tickets else 0) }} open</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-ticket-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-2 col-md-4 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Total Revenue
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                TZS {{ "{:,.0f}".format(stats.total_revenue if stats.total_revenue else 0) }}
                            </div>
                            <small class="text-muted">{{ "{:,}".format(stats.payments if stats.payments else 0) }} payments</small>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… NEW: Prediction Analytics Summary -->
    {% if stats.customers_with_predictions > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-success">
                <div class="card-header py-3 bg-light">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-chart-pie me-2"></i>Payment-Based Prediction Analytics
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="text-muted small">Average Churn Risk</div>
                            <div class="h4 mb-2">{{ (stats.avg_churn_probability * 100)|round(1) }}%</div>
                            {% if stats.avg_churn_probability < 0.3 %}
                            <span class="badge bg-success">Healthy Portfolio</span>
                            {% elif stats.avg_churn_probability < 0.6 %}
                            <span class="badge bg-warning">Monitor Closely</span>
                            {% else %}
                            <span class="badge bg-danger">High Risk Portfolio</span>
                            {% endif %}
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="text-muted small">Coverage</div>
                            <div class="h4 mb-2">
                                {{ ((stats.customers_with_predictions / stats.customers * 100) if stats.customers > 0 else 0)|round(1) }}%
                            </div>
                            <span class="badge bg-info">{{ stats.customers_with_predictions }}/{{ stats.customers }} customers</span>
                        </div>
                        <div class="col-md-6">
                            <div class="text-muted small mb-2">Risk Distribution</div>
                            <div class="progress mb-2" style="height: 25px;">
                                {% set total_predicted = stats.high_risk_customers + stats.medium_risk_customers + stats.low_risk_customers %}
                                {% if total_predicted > 0 %}
                                <div class="progress-bar bg-danger" style="width: {{ (stats.high_risk_customers / total_predicted * 100) }}%">
                                    High {{ (stats.high_risk_customers / total_predicted * 100)|round }}%
                                </div>
                                <div class="progress-bar bg-warning" style="width: {{ (stats.medium_risk_customers / total_predicted * 100) }}%">
                                    Medium {{ (stats.medium_risk_customers / total_predicted * 100)|round }}%
                                </div>
                                <div class="progress-bar bg-success" style="width: {{ (stats.low_risk_customers / total_predicted * 100) }}%">
                                    Low {{ (stats.low_risk_customers / total_predicted * 100)|round }}%
                                </div>
                                {% endif %}
                            </div>
                            <div class="small text-center">
                                ðŸ”´ {{ stats.high_risk_customers }} High Risk | 
                                ðŸŸ¡ {{ stats.medium_risk_customers }} Medium Risk | 
                                ðŸŸ¢ {{ stats.low_risk_customers }} Low Risk
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- âœ… NEW: High Risk Customers Alert Panel -->
    {% if stats.high_risk_customers > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow border-left-danger">
                <div class="card-header py-3 bg-danger text-white">
                    <h6 class="m-0 font-weight-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>ðŸš¨ HIGH RISK CUSTOMERS ALERT ({{ stats.high_risk_customers }} customers)
                    </h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger mb-3">
                        <strong>Immediate Action Required!</strong> These customers haven't made payments in 90+ days according to n.py payment analysis logic.
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Recommended Actions:</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-phone text-danger me-2"></i>Contact customers immediately</li>
                                <li><i class="fas fa-dollar-sign text-warning me-2"></i>Offer payment plans or incentives</li>
                                <li><i class="fas fa-handshake text-info me-2"></i>Review service quality issues</li>
                                <li><i class="fas fa-chart-line text-success me-2"></i>Track intervention results</li>
                            </ul>
                        </div>
                        <div class="col-md-6 text-center">
                            <button class="btn btn-danger btn-lg" onclick="viewHighRiskCustomers()">
                                <i class="fas fa-users me-2"></i>View High Risk Customers
                            </button>
                            <br><small class="text-muted mt-2 d-block">View detailed list with contact information</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- âœ… FIXED: Recent Customers with Correct Field Mappings -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-users me-2"></i>Recent Customers with Payment Risk Analysis
                    </h6>
                    <a href="{{ url_for('crm.customers') }}" class="btn btn-sm btn-primary">
                        View All <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_customers %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Customer</th>
                                    <th>Phone</th>
                                    <th>Total Tickets</th>
                                    <th>Days Since Last Payment</th>
                                    <th>Monthly Charges</th>
                                    <th>Payment Consistency</th>
                                    <th>Churn Risk</th>
                                    <th>Last Payment Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for customer in recent_customers %}
                                <tr>
                                    <td><strong>{{ customer.customer_name or 'N/A' }}</strong></td>
                                    <td>{{ customer.phone or 'N/A' }}</td>
                                    <td>{{ customer.days_since_last_payment or 0 }}</td>                                    <td>{{ customer.days_since_last_payment or 0 }}</td>
                                    <td>TZS {{ "{:,.0f}".format(customer.monthly_charges or 0) }}</td>
                                    <td>
                                        <!-- Payment consistency score with visual indicator -->
                                        {% if customer.payment_consistency_score %}
                                            {% set consistency = (customer.payment_consistency_score * 100)|round(1) %}
                                            <div class="d-flex align-items-center">
                                                <span class="me-2">{{ consistency }}%</span>
                                                <div class="progress flex-fill" style="height: 8px; width: 60px;">
                                                    <div class="progress-bar bg-{{ 'success' if consistency >= 80 else 'warning' if consistency >= 60 else 'danger' }}" 
                                                         style="width: {{ consistency }}%"></div>
                                                </div>
                                            </div>
                                        {% else %}
                                            <span class="badge bg-secondary">No Data</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if customer.churn_risk %}
                                            <span class="badge bg-{{ 'danger' if customer.churn_risk == 'high' else 'warning' if customer.churn_risk == 'medium' else 'success' }}">
                                                {{ customer.churn_risk|upper }}
                                            </span>
                                            {% if customer.churn_probability %}
                                            <small class="text-muted d-block">{{ (customer.churn_probability * 100)|round(1) }}%</small>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if customer.last_payment_date %}
                                            {{ customer.last_payment_date.strftime('%Y-%m-%d') }}
                                            <small class="text-muted d-block">{{ ((datetime.utcnow() - customer.last_payment_date).days) }} days ago</small>
                                        {% else %}
                                            <span class="text-muted">No payment data</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        No customers found. Click "{{ 'Fast Sync + Predictions' if connection_info.postgresql_configured else 'Sync CRM Data' }}" to import customers and generate predictions.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions with Enhanced Features -->
    <div class="row">
        <div class="col-md-3 mb-3">
            <div class="card shadow h-100">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-3x text-primary mb-3"></i>
                    <h5>Customers</h5>
                    <p class="text-muted small">Manage {{ "{:,}".format(stats.customers if stats.customers else 0) }} customers with payment risk analysis</p>
                    <a href="{{ url_for('crm.customers') }}" class="btn btn-primary btn-sm">
                        View Customers <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                    {% if stats.high_risk_customers > 0 %}
                    <div class="mt-2">
                        <a href="{{ url_for('crm.customers', risk='high') }}" class="btn btn-danger btn-sm">
                            {{ stats.high_risk_customers }} High Risk <i class="fas fa-exclamation-triangle ms-1"></i>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow h-100">
                <div class="card-body text-center">
                    <i class="fas fa-ticket-alt fa-3x text-info mb-3"></i>
                    <h5>Support Tickets</h5>
                    <p class="text-muted small">Manage {{ "{:,}".format(stats.tickets if stats.tickets else 0) }} customer support tickets</p>
                    <a href="{{ url_for('crm.tickets') }}" class="btn btn-info btn-sm">
                        View Tickets <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-3">
            <div class="card shadow h-100">
                <div class="card-body text-center">
                    <i class="fas fa-money-bill-wave fa-3x text-success mb-3"></i>
                    <h5>Payments</h5>
                    <p class="text-muted small">View {{ "{:,}".format(stats.payments if stats.payments else 0) }} payment transactions</p>
                    <a href="{{ url_for('crm.payments') }}" class="btn btn-success btn-sm">
                        View Payments <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>

        <!-- âœ… NEW: Prediction Analytics Quick Action -->
        <div class="col-md-3 mb-3">
            <div class="card shadow h-100">
                <div class="card-body text-center">
                    <i class="fas fa-brain fa-3x text-warning mb-3"></i>
                    <h5>Predictions</h5>
                    <p class="text-muted small">{{ "{:,}".format(stats.customers_with_predictions if stats.customers_with_predictions else 0) }} payment-based predictions</p>
                    <button class="btn btn-warning btn-sm" onclick="viewPredictionSummary()">
                        View Analytics <i class="fas fa-chart-line ms-1"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- âœ… ENHANCED: Selective Sync Modal with Prediction Options -->
<div class="modal fade" id="syncModal" tabindex="-1" aria-labelledby="syncModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="syncModalLabel">
                    <i class="fas fa-sync-alt me-2"></i>
                    Enhanced Sync with Payment-Based Predictions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if connection_info.postgresql_configured %}
                <div class="alert alert-success">
                    <i class="fas fa-rocket me-2"></i>
                    <strong>PostgreSQL + Predictions Active!</strong><br>
                    Your sync will include <strong>payment behavior analysis</strong> and generate churn predictions using n.py logic!
                </div>
                {% endif %}
                
                <p class="text-muted">Choose data types and prediction options:</p>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncCustomers" checked>
                    <label class="form-check-label" for="syncCustomers">
                        <strong><i class="fas fa-users me-2 text-primary"></i>Enhanced Customers</strong>
                        <br><small class="text-muted">Sync customer information with payment history analysis</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncPayments" checked>
                    <label class="form-check-label" for="syncPayments">
                        <strong><i class="fas fa-money-bill-wave me-2 text-success"></i>Payment Transactions</strong>
                        <br><small class="text-muted">Sync payment data for churn prediction analysis</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncTickets" checked>
                    <label class="form-check-label" for="syncTickets">
                        <strong><i class="fas fa-ticket-alt me-2 text-info"></i>Support Tickets</strong>
                        <br><small class="text-muted">Sync support tickets (affects prediction accuracy)</small>
                    </label>
                </div>
                
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="syncUsage" checked>
                    <label class="form-check-label" for="syncUsage">
                        <strong><i class="fas fa-chart-line me-2 text-warning"></i>Usage Statistics</strong>
                        <br><small class="text-muted">Sync customer usage data for comprehensive analysis</small>
                    </label>
                </div>
                
                <hr>
                
                <!-- âœ… NEW: Prediction Options -->
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="generatePredictions" checked>
                    <label class="form-check-label" for="generatePredictions">
                        <strong><i class="fas fa-brain me-2 text-danger"></i>Generate Payment-Based Predictions</strong>
                        <br><small class="text-muted">Apply n.py logic: 90-day payment rules, risk assessment, business recommendations</small>
                    </label>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>
                        <strong>Enhanced Features:</strong> 
                        {% if connection_info.postgresql_configured %}
                            Multi-table mapping (customers â†’ payments â†’ tickets â†’ usage) with real-time payment behavior analysis.
                        {% else %}
                            Basic sync with prediction generation. Configure PostgreSQL for multi-table mapping.
                        {% endif %}
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="startSyncButton">
                    <i class="fas fa-sync-alt me-2"></i>
                    {% if connection_info.postgresql_configured %}
                        Start Enhanced Sync
                    {% else %}
                        Start Sync
                    {% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- âœ… NEW: Prediction Summary Modal -->
<div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="predictionModalLabel">
                    <i class="fas fa-chart-line me-2"></i>Payment-Based Prediction Analytics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="predictionContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading predictions...</span>
                        </div>
                        <p class="mt-2">Loading prediction analytics...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" onclick="regeneratePredictions()">
                    <i class="fas fa-redo me-2"></i>Update Predictions
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const syncModal = new bootstrap.Modal(document.getElementById('syncModal'));
    const predictionModal = new bootstrap.Modal(document.getElementById('predictionModal'));
    const startSyncButton = document.getElementById('startSyncButton');
    
    // âœ… ENHANCED: Start selective sync with prediction generation
    if (startSyncButton) {
        startSyncButton.addEventListener('click', function() {
            // Get enhanced sync options including predictions
            const syncOptions = {
                sync_customers: document.getElementById('syncCustomers').checked,
                sync_payments: document.getElementById('syncPayments').checked,
                sync_tickets: document.getElementById('syncTickets').checked,
                sync_usage: document.getElementById('syncUsage').checked,
                generate_predictions: document.getElementById('generatePredictions').checked  // âœ… NEW
            };
            
            // Check if at least one option is selected
            if (!Object.values(syncOptions).some(v => v)) {
                alert('Please select at least one option to sync.');
                return;
            }
            
            // Close modal and show progress
            syncModal.hide();
            showSyncProgress();
            
            // Disable button
            startSyncButton.disabled = true;
            startSyncButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enhanced Syncing...';
            
            // Record start time
            const startTime = Date.now();
            
            // Make enhanced AJAX request
            fetch('{{ url_for("crm.sync") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(syncOptions)
            })
            .then(response => response.json())
            .then(data => {
                const elapsedTime = (Date.now() - startTime) / 1000;
                hideSyncProgress();
                
                if (data.success) {
                    let successMessage = `ðŸŽ‰ Enhanced Sync Completed!\n\n${data.message}`;
                    
                    // Add prediction summary if available
                    if (data.prediction_summary) {
                        const pred = data.prediction_summary;
                        successMessage += `\n\nðŸ§  Predictions Generated:`;
                        successMessage += `\nâ€¢ Total: ${pred.total_predictions}`;
                        successMessage += `\nâ€¢ High Risk: ${pred.high_risk}`;
                        successMessage += `\nâ€¢ Medium Risk: ${pred.medium_risk}`;
                        successMessage += `\nâ€¢ Low Risk: ${pred.low_risk}`;
                    }
                    
                    // Add performance info
                    if (data.performance) {
                        successMessage += `\n\nâš¡ Performance:`;
                        successMessage += `\nâ€¢ ${data.performance.records_per_second} records/sec`;
                        successMessage += `\nâ€¢ ${data.performance.sync_duration}s duration`;
                        if (data.performance.predictions_generated) {
                            successMessage += `\nâ€¢ ${data.performance.predictions_generated} predictions`;
                        }
                    }
                    
                    alert(successMessage);
                    
                    // Reload page to show updated data
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    alert(`âŒ Enhanced Sync Failed!\n\n${data.message}`);
                }
            })
            .catch(error => {
                hideSyncProgress();
                alert('âŒ Enhanced Sync Error: ' + error.message);
            })
            .finally(() => {
                // Re-enable button
                startSyncButton.disabled = false;
                {% if connection_info.postgresql_configured %}
                startSyncButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Start Enhanced Sync';
                {% else %}
                startSyncButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Start Sync';
                {% endif %}
            });
        });
    }
    
    // âœ… NEW: Prediction-specific functions
    window.viewPredictionSummary = function() {
        predictionModal.show();
        
        fetch('/crm/predictions/summary')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const stats = data.prediction_stats;
                    const highRisk = data.high_risk_customers;
                    
                    let content = `
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Prediction Statistics</h6>
                                <ul class="list-group">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Total Customers
                                        <span class="badge bg-primary rounded-pill">${stats.total_customers}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        With Predictions
                                        <span class="badge bg-info rounded-pill">${stats.customers_with_predictions}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        High Risk (90+ days)
                                        <span class="badge bg-danger rounded-pill">${stats.high_risk}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Medium Risk (60+ days)
                                        <span class="badge bg-warning rounded-pill">${stats.medium_risk}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Low Risk
                                        <span class="badge bg-success rounded-pill">${stats.low_risk}</span>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Average Churn Risk</h6>
                                <div class="text-center mb-3">
                                    <h3>${(stats.avg_churn_probability * 100).toFixed(1)}%</h3>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-${stats.avg_churn_probability > 0.6 ? 'danger' : stats.avg_churn_probability > 0.3 ? 'warning' : 'success'}" 
                                             style="width: ${stats.avg_churn_probability * 100}%">
                                        </div>
                                    </div>
                                </div>
                                ${stats.last_prediction_date ? `<small class="text-muted">Last updated: ${new Date(stats.last_prediction_date).toLocaleString()}</small>` : ''}
                            </div>
                        </div>`;
                    
                    if (highRisk.length > 0) {
                        content += `
                            <h6>Top High-Risk Customers (Immediate Action Required)</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Customer</th>
                                            <th>Risk %</th>
                                            <th>Phone</th>
                                            <th>Last Payment</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                        
                        highRisk.forEach(customer => {
                            content += `
                                <tr>
                                    <td><strong>${customer.name}</strong></td>
                                    <td><span class="badge bg-danger">${(customer.probability * 100).toFixed(1)}%</span></td>
                                    <td>${customer.phone || 'N/A'}</td>
                                    <td>${customer.last_payment_date ? new Date(customer.last_payment_date).toLocaleDateString() : 'No recent payments'}</td>
                                </tr>`;
                        });
                        
                        content += `
                                    </tbody>
                                </table>
                            </div>`;
                    }
                    
                    document.getElementById('predictionContent').innerHTML = content;
                } else {
                    document.getElementById('predictionContent').innerHTML = `
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${data.message || 'Unable to load prediction data'}
                        </div>`;
                }
            })
            .catch(error => {
                document.getElementById('predictionContent').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times me-2"></i>
                        Error loading predictions: ${error.message}
                    </div>`;
            });
    };
    
    window.regeneratePredictions = function() {
        if (confirm('Regenerate predictions for all customers? This may take a few minutes.')) {
            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Regenerating...';
            
            fetch('/crm/predictions/regenerate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`âœ… Predictions Updated!\n\n${data.message}`);
                    window.location.reload();
                } else {
                    alert(`âŒ Prediction Update Failed!\n\n${data.message}`);
                }
            })
            .catch(error => {
                alert('âŒ Error: ' + error.message);
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }
    };
    
    window.viewHighRiskCustomers = function() {
        window.location.href = '{{ url_for("crm.customers", risk="high") }}';
    };
    
    window.showConnectionInfo = function() {
        const message = `Enhanced PostgreSQL Connection with Predictions

âœ… Direct database access to all 4 tables
ðŸ§  Payment-based churn prediction (n.py logic)
âš¡ Multi-table customer mapping
ðŸ“Š Real-time risk assessment
ðŸ’¾ Enhanced performance
ðŸŽ¯ Business recommendation engine

Tables Connected:
â€¢ crm_customers (customer profiles)
â€¢ nav_mpesa_transactions (payment behavior)
â€¢ crm_tickets (support history)
â€¢ spl_statistics (usage patterns)

Your enhanced CRM integration is performing excellently!`;
        alert(message);
    };
    
    // Helper functions
    function showSyncProgress() {
        // Create or show progress indicator
        let progressAlert = document.getElementById('syncProgressAlert');
        if (!progressAlert) {
            progressAlert = document.createElement('div');
            progressAlert.id = 'syncProgressAlert';
            progressAlert.className = 'alert alert-info alert-dismissible fade show position-fixed';
            progressAlert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            progressAlert.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-3" role="status"></div>
                    <div>
                        <strong>Enhanced sync in progress...</strong>
                        <p class="mb-0 small">Processing customers, payments, tickets, usage, and generating predictions...</p>
                    </div>
                </div>`;
            document.body.appendChild(progressAlert);
        } else {
            progressAlert.style.display = 'block';
            progressAlert.classList.add('show');
        }
    }
    
    function hideSyncProgress() {
        const progressAlert = document.getElementById('syncProgressAlert');
        if (progressAlert) {
            progressAlert.classList.remove('show');
            setTimeout(() => {
                progressAlert.style.display = 'none';
            }, 300);
        }
    }
});
</script>

<!-- âœ… Enhanced CSS for prediction features -->
<style>
.border-left-primary { border-left: 4px solid #007bff !important; }
.border-left-success { border-left: 4px solid #28a745 !important; }
.border-left-info { border-left: 4px solid #17a2b8 !important; }
.border-left-warning { border-left: 4px solid #ffc107 !important; }
.border-left-danger { border-left: 4px solid #dc3545 !important; }
.border-left-secondary { border-left: 4px solid #6c757d !important; }

/* Enhanced prediction styling */
.prediction-highlight {
    animation: predictionPulse 2s ease-in-out infinite;
}

@keyframes predictionPulse {
    0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
}

.high-risk-alert {
    border-left: 5px solid #dc3545 !important;
    background: linear-gradient(90deg, rgba(220,53,69,0.1) 0%, rgba(255,255,255,1) 100%);
}
</style>
{% endblock %}