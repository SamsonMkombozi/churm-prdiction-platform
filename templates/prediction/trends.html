{% extends 'base.html' %}

{% block title %}High Risk Customers - {{ company.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-exclamation-triangle text-danger me-2"></i>High Risk Customers
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-danger me-2" onclick="exportHighRisk()">
                <i class="fas fa-download me-2"></i>Export High Risk List
            </button>
            <button type="button" class="btn btn-warning me-2" onclick="sendBulkAlerts()">
                <i class="fas fa-bell me-2"></i>Send Alerts
            </button>
            <a href="{{ url_for('prediction.customers') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Predictions
            </a>
        </div>
    </div>

    <!-- Alert Banner -->
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
            <div>
                <h5 class="alert-heading mb-1">Critical Alert: Immediate Action Required</h5>
                <p class="mb-1">
                    <strong>{{ total_high_risk }} customers</strong> have been identified as high churn risk (≥70% probability). 
                    These customers require immediate attention to prevent potential revenue loss.
                </p>
                <small class="text-muted">
                    Estimated revenue at risk: <strong>KSH {{ "{:,.0f}".format(total_revenue_at_risk) }}</strong>
                </small>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left-danger shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                        High Risk Customers
                    </div>
                    <div class="h4 mb-0 font-weight-bold text-danger">{{ total_high_risk|number }}</div>
                    <small class="text-muted">≥70% churn probability</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                        Average Risk Score
                    </div>
                    <div class="h4 mb-0 font-weight-bold text-warning">{{ average_risk_score|round(1) }}%</div>
                    <small class="text-muted">Across all high-risk customers</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-info shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                        Revenue at Risk
                    </div>
                    <div class="h4 mb-0 font-weight-bold text-info">KSH {{ "{:,.0f}".format(total_revenue_at_risk) }}</div>
                    <small class="text-muted">Monthly recurring revenue</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Avg Customer Value
                    </div>
                    <div class="h4 mb-0 font-weight-bold text-success">KSH {{ "{:,.0f}".format(average_customer_value) }}</div>
                    <small class="text-muted">Per high-risk customer</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Distribution Chart -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-chart-bar me-2"></i>Risk Score Distribution
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="riskDistributionChart" height="150"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-danger">
                        <i class="fas fa-clock me-2"></i>Urgency Levels
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-danger">Critical (≥90%)</span>
                            <strong class="text-danger">{{ critical_count }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-danger" style="width: {{ (critical_count / total_high_risk * 100)|round(1) if total_high_risk > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-warning">High (80-89%)</span>
                            <strong class="text-warning">{{ high_count }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" style="width: {{ (high_count / total_high_risk * 100)|round(1) if total_high_risk > 0 else 0 }}%"></div>
                        </div>
                    </div>
                    <div class="mb-0">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="small text-secondary">Moderate (70-79%)</span>
                            <strong class="text-secondary">{{ moderate_count }}</strong>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-secondary" style="width: {{ (moderate_count / total_high_risk * 100)|round(1) if total_high_risk > 0 else 0 }}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('prediction.high_risk') }}" class="row g-3">
                <div class="col-md-2">
                    <label for="urgency" class="form-label">Urgency</label>
                    <select name="urgency" id="urgency" class="form-select">
                        <option value="">All Levels</option>
                        <option value="critical" {% if current_urgency == 'critical' %}selected{% endif %}>Critical (≥90%)</option>
                        <option value="high" {% if current_urgency == 'high' %}selected{% endif %}>High (80-89%)</option>
                        <option value="moderate" {% if current_urgency == 'moderate' %}selected{% endif %}>Moderate (70-79%)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="tenure" class="form-label">Tenure</label>
                    <select name="tenure" id="tenure" class="form-select">
                        <option value="">All Tenure</option>
                        <option value="new" {% if current_tenure == 'new' %}selected{% endif %}>New (≤6 months)</option>
                        <option value="medium" {% if current_tenure == 'medium' %}selected{% endif %}>Medium (7-24 months)</option>
                        <option value="long" {% if current_tenure == 'long' %}selected{% endif %}>Long (>24 months)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="sort" class="form-label">Sort By</label>
                    <select name="sort" id="sort" class="form-select">
                        <option value="probability" {% if current_sort == 'probability' %}selected{% endif %}>Risk Score</option>
                        <option value="value" {% if current_sort == 'value' %}selected{% endif %}>Customer Value</option>
                        <option value="tenure" {% if current_sort == 'tenure' %}selected{% endif %}>Tenure</option>
                        <option value="recent" {% if current_sort == 'recent' %}selected{% endif %}>Recently Updated</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="Customer name or email" value="{{ current_search or '' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-2"></i>Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- High Risk Customers Table -->
    <div class="card shadow">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-danger">
                High Risk Customer Details ({{ customers|length }} showing)
            </h6>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                <label class="form-check-label" for="selectAll">
                    Select All
                </label>
            </div>
        </div>
        <div class="card-body">
            {% if customers %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th width="30px">
                                <input type="checkbox" class="form-check-input" id="headerSelect" onchange="toggleSelectAll()">
                            </th>
                            <th>#</th>
                            <th>Customer</th>
                            <th>Risk Score</th>
                            <th>Urgency</th>
                            <th>Tenure</th>
                            <th>Monthly Value</th>
                            <th>Outstanding Balance</th>
                            <th>Last Activity</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>
                                <input type="checkbox" class="form-check-input customer-select" value="{{ customer.id }}">
                            </td>
                            <td>{{ loop.index }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        {% if customer.churn_probability >= 0.9 %}
                                        <i class="fas fa-exclamation-circle text-danger" title="Critical Risk"></i>
                                        {% elif customer.churn_probability >= 0.8 %}
                                        <i class="fas fa-exclamation-triangle text-warning" title="High Risk"></i>
                                        {% else %}
                                        <i class="fas fa-exclamation text-secondary" title="Moderate Risk"></i>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <strong>{{ customer.customer_name }}</strong>
                                        {% if customer.email %}
                                        <br><small class="text-muted">{{ customer.email }}</small>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 20px; min-width: 100px;">
                                        <div class="progress-bar bg-danger" role="progressbar" 
                                             style="width: {{ customer.churn_probability * 100 }}%">
                                            {{ (customer.churn_probability * 100)|round(1) }}%
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                {% if customer.churn_probability >= 0.9 %}
                                <span class="badge bg-danger">CRITICAL</span>
                                {% elif customer.churn_probability >= 0.8 %}
                                <span class="badge bg-warning">HIGH</span>
                                {% else %}
                                <span class="badge bg-secondary">MODERATE</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'danger' if customer.tenure_months <= 6 else 'warning' if customer.tenure_months <= 24 else 'success' }}">
                                    {{ customer.tenure_months }} mo
                                </span>
                            </td>
                            <td>
                                <strong class="text-success">KSH {{ "{:,.0f}".format(customer.monthly_charges) }}</strong>
                            </td>
                            <td>
                                <span class="text-{{ 'danger' if customer.outstanding_balance > 0 else 'success' }}">
                                    KSH {{ "{:,.0f}".format(customer.outstanding_balance) }}
                                </span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {% if customer.last_payment_date %}
                                    Payment: {{ customer.last_payment_date|date }}
                                    {% elif customer.last_ticket_date %}
                                    Ticket: {{ customer.last_ticket_date|date }}
                                    {% else %}
                                    No recent activity
                                    {% endif %}
                                </small>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-danger" onclick="initiateRetention({{ customer.id }})">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                    <a href="{{ url_for('crm.customer_detail', customer_id=customer.id) }}" 
                                       class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-warning" onclick="scheduleFollowup({{ customer.id }})">
                                        <i class="fas fa-calendar"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <button type="button" class="btn btn-danger" onclick="bulkRetentionActions()" disabled id="bulkActionsBtn">
                        <i class="fas fa-users me-2"></i>Bulk Retention Actions (<span id="selectedCount">0</span>)
                    </button>
                </div>
                <div>
                    <small class="text-muted">
                        Total estimated monthly revenue loss if all churn: <strong>KSH {{ "{:,.0f}".format(total_revenue_at_risk) }}</strong>
                    </small>
                </div>
            </div>

            {% else %}
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i>
                <strong>Excellent news!</strong> No high-risk customers found. Your retention efforts are working well!
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Action Recommendations -->
    <div class="card shadow mt-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h6 class="m-0 font-weight-bold">
                <i class="fas fa-lightbulb me-2"></i>Retention Strategy Recommendations
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <h6 class="text-danger">Critical Actions (24-48 hours):</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Contact customers with ≥90% risk immediately</li>
                        <li><i class="fas fa-check text-success me-2"></i>Review and resolve outstanding support tickets</li>
                        <li><i class="fas fa-check text-success me-2"></i>Address billing issues and payment delays</li>
                        <li><i class="fas fa-check text-success me-2"></i>Offer immediate retention incentives</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-warning">Short-term Strategies (1-2 weeks):</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Schedule personal check-in calls</li>
                        <li><i class="fas fa-check text-success me-2"></i>Conduct service satisfaction surveys</li>
                        <li><i class="fas fa-check text-success me-2"></i>Provide additional service benefits</li>
                        <li><i class="fas fa-check text-success me-2"></i>Implement account management plans</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h6 class="text-info">Long-term Prevention (1-3 months):</h6>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-check text-success me-2"></i>Improve overall service quality</li>
                        <li><i class="fas fa-check text-success me-2"></i>Enhance customer onboarding process</li>
                        <li><i class="fas fa-check text-success me-2"></i>Develop loyalty and rewards programs</li>
                        <li><i class="fas fa-check text-success me-2"></i>Regular proactive customer engagement</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Retention Action Modal -->
<div class="modal fade" id="retentionActionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Initiate Retention Action
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="retentionContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Risk Distribution Chart
const ctx = document.getElementById('riskDistributionChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['70-74%', '75-79%', '80-84%', '85-89%', '90-94%', '95-100%'],
        datasets: [{
            label: 'Number of Customers',
            data: {{ risk_distribution|default([0,0,0,0,0,0])|list }},
            backgroundColor: [
                '#ffc107', '#fd7e14', '#dc3545', '#dc3545', '#8b0000', '#4a0000'
            ],
            borderColor: [
                '#e0a800', '#e8610d', '#c82333', '#c82333', '#7a0000', '#3d0000'
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Selection management
function toggleSelectAll() {
    const selectAll = document.getElementById('headerSelect');
    const customerSelects = document.querySelectorAll('.customer-select');
    
    customerSelects.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActionButton();
}

function updateBulkActionButton() {
    const selectedBoxes = document.querySelectorAll('.customer-select:checked');
    const bulkBtn = document.getElementById('bulkActionsBtn');
    const countSpan = document.getElementById('selectedCount');
    
    countSpan.textContent = selectedBoxes.length;
    bulkBtn.disabled = selectedBoxes.length === 0;
}

// Add event listeners to checkboxes
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.customer-select').forEach(checkbox => {
        checkbox.addEventListener('change', updateBulkActionButton);
    });
});

// Initiate retention action for single customer
function initiateRetention(customerId) {
    // Load customer details and show retention modal
    document.getElementById('retentionContent').innerHTML = `
        <div class="text-center">
            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Loading customer details...</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('retentionActionModal')).show();
    
    // Simulate loading customer data
    setTimeout(() => {
        document.getElementById('retentionContent').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Immediate Actions:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="call${customerId}">
                        <label class="form-check-label" for="call${customerId}">
                            Call customer within 2 hours
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="email${customerId}">
                        <label class="form-check-label" for="email${customerId}">
                            Send personalized retention email
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="discount${customerId}">
                        <label class="form-check-label" for="discount${customerId}">
                            Offer 20% discount for 3 months
                        </label>
                    </div>
                </div>
                <div class="col-md-6">
                    <h6>Follow-up Actions:</h6>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="survey${customerId}">
                        <label class="form-check-label" for="survey${customerId}">
                            Send satisfaction survey
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="manager${customerId}">
                        <label class="form-check-label" for="manager${customerId}">
                            Assign dedicated account manager
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="meeting${customerId}">
                        <label class="form-check-label" for="meeting${customerId}">
                            Schedule in-person meeting
                        </label>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <label class="form-label">Notes:</label>
                <textarea class="form-control" id="notes${customerId}" rows="3" placeholder="Add specific notes for this customer..."></textarea>
            </div>
            <div class="mt-3 text-end">
                <button class="btn btn-danger" onclick="executeRetentionPlan(${customerId})">
                    <i class="fas fa-rocket me-2"></i>Execute Plan
                </button>
            </div>
        `;
    }, 1000);
}

// Schedule follow-up
function scheduleFollowup(customerId) {
    alert(`Follow-up scheduled for customer ${customerId}. You will be reminded in 3 days.`);
}

// Bulk retention actions
function bulkRetentionActions() {
    const selectedCustomers = Array.from(document.querySelectorAll('.customer-select:checked')).map(cb => cb.value);
    
    if (selectedCustomers.length === 0) {
        alert('Please select customers first.');
        return;
    }
    
    const confirmed = confirm(`Execute retention actions for ${selectedCustomers.length} customers?`);
    if (confirmed) {
        alert(`Retention actions initiated for ${selectedCustomers.length} customers. You will receive updates as actions are completed.`);
    }
}

// Send bulk alerts
function sendBulkAlerts() {
    const confirmed = confirm(`Send retention alerts to all ${total_high_risk} high-risk customers?`);
    if (confirmed) {
        alert(`Alerts sent to all high-risk customers. The retention team has been notified.`);
    }
}

// Export high risk customers
function exportHighRisk() {
    window.location.href = '{{ url_for("prediction.export_high_risk") }}';
}

// Execute retention plan
function executeRetentionPlan(customerId) {
    alert(`Retention plan executed for customer ${customerId}. All selected actions have been initiated.`);
    bootstrap.Modal.getInstance(document.getElementById('retentionActionModal')).hide();
}
</script>
{% endblock %}