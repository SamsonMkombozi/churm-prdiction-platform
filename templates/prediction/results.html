<!-- templates/prediction/results.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prediction Results</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .risk-high { background-color: #f8d7da; }
        .risk-medium { background-color: #fff3cd; }
        .risk-low { background-color: #d1edff; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('prediction.dashboard') }}">Predictions</a></li>
                <li class="breadcrumb-item active">Results</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">Prediction Results</h1>
            <div>
                <button class="btn btn-success" onclick="exportResults()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <a href="{{ url_for('prediction.upload') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload New Data
                </a>
            </div>
        </div>

        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Summary Statistics -->
        {% if results %}
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-primary">{{ results|length }}</h5>
                        <p class="card-text">Total Predictions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-danger">{{ results|selectattr('risk_level', 'equalto', 'High')|list|length }}</h5>
                        <p class="card-text">High Risk</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-warning">{{ results|selectattr('risk_level', 'equalto', 'Medium')|list|length }}</h5>
                        <p class="card-text">Medium Risk</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title text-success">{{ results|selectattr('risk_level', 'equalto', 'Low')|list|length }}</h5>
                        <p class="card-text">Low Risk</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="m-0">Churn Prediction Results</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Customer ID</th>
                                <th>Churn Probability</th>
                                <th>Risk Level</th>
                                <th>Prediction Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr class="risk-{{ result.risk_level|lower }}">
                                <td>{{ result.customer_id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                            <div class="progress-bar 
                                                {% if result.churn_probability >= 0.7 %}bg-danger
                                                {% elif result.churn_probability >= 0.4 %}bg-warning
                                                {% else %}bg-success{% endif %}" 
                                                role="progressbar" 
                                                style="width: {{ (result.churn_probability * 100)|round(1) }}%">
                                            </div>
                                        </div>
                                        <span class="small">{{ (result.churn_probability * 100)|round(1) }}%</span>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if result.risk_level == 'High' %}bg-danger
                                        {% elif result.risk_level == 'Medium' %}bg-warning
                                        {% else %}bg-success{% endif %}">
                                        {{ result.risk_level }}
                                    </span>
                                </td>
                                <td>{{ result.prediction_date[:19] if result.prediction_date else 'N/A' }}</td>
                                <td>
                                    {% if result.risk_level == 'High' %}
                                        <button class="btn btn-sm btn-outline-danger" onclick="showRetentionSuggestions('{{ result.customer_id }}')">
                                            <i class="fas fa-exclamation-triangle"></i> Action Needed
                                        </button>
                                    {% elif result.risk_level == 'Medium' %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="showRetentionSuggestions('{{ result.customer_id }}')">
                                            <i class="fas fa-eye"></i> Monitor
                                        </button>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-success" disabled>
                                            <i class="fas fa-check"></i> Stable
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {% else %}
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle fa-3x mb-3"></i>
            <h4>No Results Available</h4>
            <p>No prediction results to display. <a href="{{ url_for('prediction.upload') }}">Upload customer data</a> to generate predictions.</p>
        </div>
        {% endif %}

        <!-- Retention Suggestions Modal -->
        <div class="modal fade" id="retentionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Retention Suggestions</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <h6>Recommended Actions:</h6>
                        <ul>
                            <li>Offer loyalty discount or promotion</li>
                            <li>Schedule personal check-in call</li>
                            <li>Provide additional service benefits</li>
                            <li>Review and optimize service plan</li>
                            <li>Gather feedback on satisfaction</li>
                        </ul>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Implement Actions</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        function exportResults() {
            // Create CSV content
            let csvContent = "Customer ID,Churn Probability,Risk Level,Prediction Date\n";
            
            {% if results %}
            {% for result in results %}
            csvContent += "{{ result.customer_id }},{{ result.churn_probability }},{{ result.risk_level }},{{ result.prediction_date }}\n";
            {% endfor %}
            {% endif %}

            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'churn_predictions_' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function showRetentionSuggestions(customerId) {
            document.querySelector('#retentionModal .modal-title').textContent = 
                'Retention Suggestions for Customer ' + customerId;
            new bootstrap.Modal(document.getElementById('retentionModal')).show();
        }
    </script>
</body>
</html>