{% extends 'base.html' %}

{% block title %}Customer Predictions{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-brain me-2"></i>Customer Predictions
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-primary me-2" id="runPredictionsBtn">
                <i class="fas fa-brain me-2"></i>Run Batch Predictions
            </button>
            <button type="button" class="btn btn-success me-2" onclick="exportPredictions()">
                <i class="fas fa-download me-2"></i>Export Results
            </button>
            <a href="#" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card border-left-primary shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                        Total Customers
                    </div>
                    <div class="h5 mb-0 font-weight-bold">{{ (customers|length) if customers else 0 }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-danger shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                        High Risk
                    </div>
                    <div class="h5 mb-0 font-weight-bold">
                        {{ (customers|selectattr('churn_risk', 'equalto', 'high')|list|length) if customers else 0 }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-warning shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                        Medium Risk
                    </div>
                    <div class="h5 mb-0 font-weight-bold">
                        {{ (customers|selectattr('churn_risk', 'equalto', 'medium')|list|length) if customers else 0 }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card border-left-success shadow h-100">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                        Low Risk
                    </div>
                    <div class="h5 mb-0 font-weight-bold">
                        {{ (customers|selectattr('churn_risk', 'equalto', 'low')|list|length) if customers else 0 }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <form method="GET" action="#" class="row g-3">
                <div class="col-md-3">
                    <label for="risk" class="form-label">Churn Risk</label>
                    <select name="risk" id="risk" class="form-select">
                        <option value="">All Risk Levels</option>
                        <option value="high">High Risk</option>
                        <option value="medium">Medium Risk</option>
                        <option value="low">Low Risk</option>
                        <option value="no_prediction">No Prediction</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sort" class="form-label">Sort By</label>
                    <select name="sort" id="sort" class="form-select">
                        <option value="probability">Churn Probability</option>
                        <option value="name">Customer Name</option>
                        <option value="tenure">Tenure</option>
                        <option value="recent">Recently Predicted</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="search" class="form-label">Search</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="Customer name or email">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-filter me-2"></i>Apply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customers Table -->
    <div class="card shadow">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                {% if customers %}
                    Showing {{ customers|length }} customers
                {% else %}
                    No customers available
                {% endif %}
            </h6>
        </div>
        <div class="card-body">
            {% if customers %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Customer</th>
                            <th>Churn Risk</th>
                            <th>Probability</th>
                            <th>Tenure</th>
                            <th>Monthly Charges</th>
                            <th>Balance</th>
                            <th>Last Prediction</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for customer in customers %}
                        <tr>
                            <td>{{ loop.index }}</td>
                            <td>
                                <div>
                                    <strong>{{ customer.customer_name or 'Unknown Customer' }}</strong>
                                    {% if customer.email %}
                                    <br><small class="text-muted">{{ customer.email }}</small>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if customer.churn_risk %}
                                <span class="badge bg-{{ 'danger' if customer.churn_risk == 'high' else 'warning' if customer.churn_risk == 'medium' else 'success' }}">
                                    {{ customer.churn_risk|upper }}
                                </span>
                                {% else %}
                                <span class="text-muted">No prediction</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if customer.churn_probability %}
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 15px; min-width: 80px;">
                                        <div class="progress-bar bg-{{ 'danger' if customer.churn_risk == 'high' else 'warning' if customer.churn_risk == 'medium' else 'success' }}" 
                                             role="progressbar" style="width: {{ (customer.churn_probability * 100)|round(1) }}%">
                                        </div>
                                    </div>
                                    <small>{{ (customer.churn_probability * 100)|round(1) }}%</small>
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>{{ customer.tenure_months or 0 }} months</td>
                            <td>KSH {{ "{:,.0f}".format(customer.monthly_charges or 0) }}</td>
                            <td>
                                <span class="text-{{ 'danger' if (customer.outstanding_balance or 0) > 0 else 'success' }}">
                                    KSH {{ "{:,.0f}".format(customer.outstanding_balance or 0) }}
                                </span>
                            </td>
                            <td>
                                {% if customer.last_prediction_date %}
                                {{ customer.last_prediction_date }}
                                {% else %}
                                <span class="text-muted">Never</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="runSinglePrediction({{ customer.id or 0 }})">
                                        <i class="fas fa-brain"></i>
                                    </button>
                                    <a href="#" class="btn btn-sm btn-primary">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    {% if customer.churn_risk == 'high' %}
                                    <button type="button" class="btn btn-sm btn-danger" onclick="showRetentionActions({{ customer.id or 0 }})">
                                        <i class="fas fa-exclamation-triangle"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>
                No customers found. Please sync CRM data first or add some sample data for testing.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Retention Actions Modal -->
<div class="modal fade" id="retentionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Retention Actions Required
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-danger">Immediate Actions:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="contact24h">
                            <label class="form-check-label" for="contact24h">
                                Contact customer within 24 hours
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="reviewTickets">
                            <label class="form-check-label" for="reviewTickets">
                                Review and resolve outstanding tickets
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="offerIncentive">
                            <label class="form-check-label" for="offerIncentive">
                                Offer retention incentive/discount
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addressBilling">
                            <label class="form-check-label" for="addressBilling">
                                Address billing issues
                            </label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">Follow-up Actions:</h6>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="scheduleCall">
                            <label class="form-check-label" for="scheduleCall">
                                Schedule follow-up call
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="serviceReview">
                            <label class="form-check-label" for="serviceReview">
                                Conduct service quality review
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="loyaltyProgram">
                            <label class="form-check-label" for="loyaltyProgram">
                                Enroll in loyalty program
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="satisfactionSurvey">
                            <label class="form-check-label" for="satisfactionSurvey">
                                Send satisfaction survey
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label for="retentionNotes" class="form-label">Notes:</label>
                    <textarea class="form-control" id="retentionNotes" rows="3" placeholder="Add any specific notes or observations..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger" onclick="saveRetentionPlan()">
                    <i class="fas fa-save me-2"></i>Save Action Plan
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Run batch predictions
document.getElementById('runPredictionsBtn').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Running Predictions...';
    
    // Simulate API call
    setTimeout(() => {
        alert('✅ Batch predictions completed!\n\nResults:\n• High Risk: 8\n• Medium Risk: 15\n• Low Risk: 77');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-brain me-2"></i>Run Batch Predictions';
    }, 2000);
});

// Run single customer prediction
function runSinglePrediction(customerId) {
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    // Simulate API call
    setTimeout(() => {
        alert(`✅ Prediction updated for customer ${customerId}!\nRisk Level: HIGH\nProbability: 85%`);
        button.disabled = false;
        button.innerHTML = originalHtml;
    }, 1500);
}

// Show retention actions modal
function showRetentionActions(customerId) {
    document.getElementById('retentionModal').setAttribute('data-customer-id', customerId);
    new bootstrap.Modal(document.getElementById('retentionModal')).show();
}

// Save retention plan
function saveRetentionPlan() {
    const customerId = document.getElementById('retentionModal').getAttribute('data-customer-id');
    const actions = [];
    const checkboxes = document.querySelectorAll('#retentionModal input[type="checkbox"]:checked');
    checkboxes.forEach(cb => actions.push(cb.nextElementSibling.textContent.trim()));
    
    const notes = document.getElementById('retentionNotes').value;
    
    alert(`Retention plan saved for customer ${customerId}:\n\nActions:\n${actions.join('\n')}\n\nNotes: ${notes}`);
    
    bootstrap.Modal.getInstance(document.getElementById('retentionModal')).hide();
}

// Export predictions
function exportPredictions() {
    alert('Exporting predictions data... (This would download a CSV file in the real application)');
}
</script>
{% endblock %}